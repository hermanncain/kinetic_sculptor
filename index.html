<!DOCTYPE html>
<html>
	<head>
		<title>Kinetic Sculpture Gallery</title>
		<meta charset="utf-8">
		<script src="utils/three.min.js"></script>
		<script src="utils/signals.min.js"></script>
		<script src="utils/ui.js"></script>
		<script src="utils/TrackballControls.js"></script>
		<script src="utils/OutlineEffect.js"></script>
		<script src="OBJLoader.js"></script>
		<script src="Topbar.js"></script>
		<script src="Sidebar.js"></script>
	</head>
	<body>
		<link href="css/main.css" rel="stylesheet" />
		<link id="theme" href="css/light.css" rel="stylesheet" />
		<script src="WordList.js"></script>
		<script src="layout.js"></script>
		<script src="Element.js"></script>
		<script src="Sculpture.js"></script>
		<!-->script src="Rule.js"></script-->
		<!-->script src="utils/d3.min.js"></script-->
		<!-->script src="StringCalc.js"></script-->
		<!-->script src="TreeOperation.js"></script-->
		<!--script src="d3Tree.js"></script-->
		<script>

			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;

			// dom
			var container = new UI.Panel();
			container.setId('viewport');
			document.body.appendChild( container.dom );

			var Signal = signals.Signal;
			signals = {
				sceneBackgroundChanged: new Signal(),
				unitMaterialChanged: new Signal(),
				axisChanged: new Signal(),
				layoutChanged: new Signal(),
				unitChanged: new Signal()
			};

			var renderer = new THREE.WebGLRenderer( { antialias: true } );
			renderer.setClearColor( 0xFAFFFF );
			renderer.setPixelRatio( window.devicePixelRatio );
			renderer.setSize( container.dom.offsetWidth, container.dom.offsetHeight );
			container.dom.appendChild( renderer.domElement );
			effect = new THREE.OutlineEffect( renderer );

			// scene backgrounds
			var sceneBackgroundNameList = ['none','scene1','scene2'];
			var cubemapLoader = new THREE.CubeTextureLoader();
			function loadCubeMap(name) {
				cubemapLoader.setPath( 'cubemaps/'+name+'/' );
				var texture = cubemapLoader.load( [ 'px.png', 'nx.png', 'py.png', 'ny.png', 'pz.png', 'nz.png' ] );
				texture.name = name;
				return texture;
			}
			var pureColor = new THREE.Color(0xdcdcdc);
			pureColor.name = 'none';
			var sceneBackgroundLib = {
				'none': pureColor,
				'scene1': loadCubeMap('scene1'),
				'scene2': loadCubeMap('scene2')
			};
			var currentSceneBackground = sceneBackgroundLib[sceneBackgroundNameList[0]];

			// unit materials
			var mat1 = new THREE.MeshStandardMaterial({color:0x8c8c8c, emessive: 0x202020, roughness:1, metalness:0.5});
			mat1.name = 'standard';
			var mat2 = new THREE.MeshToonMaterial({color:0x8c8c8c, specular:0x000000,reflectivity:0, shininess:1 });
			mat2.name = 'toon';
			var mat3 = new THREE.MeshBasicMaterial();
			mat3.name = 'reflective';
			var mat4 = new THREE.MeshPhongMaterial( { color: 0xccfffd, refractionRatio: 0.985 } );
			mat4.name = 'glass';
			var mat5 = new THREE.MeshBasicMaterial();
			mat5.name = 'custom';
			var unitMatNameList = ['standard','toon','reflective','glass','custom'];
			var unitMatLib = {'standard':mat1, 'toon':mat2, 'reflective':mat3, 'glass': mat4, 'custom':mat5};
			var currentUnitMat = unitMatLib[unitMatNameList[0]];

			// axis shape
			var axisLib = {
				'circle': new Element('circle','20,70,z'),
				'line': new Element('line','1,10,1,0,10,0'),
				'spiral': new Element('spiral','40,40,1,15,5'),
				'heart': new Element('heart','30,2'),
			};

			//

			// unit shape
			var objLoader = new THREE.OBJLoader();
			objLoader.setPath( 'meshes/' );

			function generateDefaultUnit (mat) {
				var plate = new THREE.Mesh(new THREE.CylinderGeometry(5,5,1), mat);
				plate.translateX(20);
				plate.rotateX(Math.PI/2);
				var bar = new THREE.Mesh(new THREE.CylinderGeometry(0.5,0.5,20), mat);
				bar.rotateZ(Math.PI/2);
				bar.translateY(-10);
				var bear = new THREE.Mesh(new THREE.CylinderGeometry(1,1,2), mat);
				var unit = new THREE.Group();
				unit.add(plate,bar,bear);
				unit.name = 'unit';
				return unit;
			}
			var unitList = ['default','10','N1','N3','N4'];
			var unitLib = {};
			// load all meshes
			for (let name of unitList) {
				if (name=='default') {
					unitLib[name] = generateDefaultUnit(currentUnitMat);
					continue;
				}
				objLoader.load(name+'.obj',function(object) {
					object.name = 'unit';
					object.children[0].material = currentUnitMat;
					unitLib[name] = object;
				});
			}
			var currentUnit = unitLib[unitList[0]];

			// scene
			var scene = new THREE.Scene();
			scene.background = currentSceneBackground;

			scene.add( new THREE.AmbientLight( 0x787878 ) );

			var lights = [];
			lights[ 0 ] = new THREE.PointLight( 0xffffff, 1, 0 );
			lights[ 1 ] = new THREE.PointLight( 0xffffff, 1, 0 );
			lights[ 2 ] = new THREE.PointLight( 0xffffff, 1, 0 );

			lights[ 0 ].position.set( 0, 200, 0 );
			lights[ 1 ].position.set( 100, 200, 100 );
			lights[ 2 ].position.set( - 100, - 200, - 100 );

			scene.add( lights[ 0 ] );
			scene.add( lights[ 1 ] );
			scene.add( lights[ 2 ] );

			// main camera
			var camera = new THREE.PerspectiveCamera( 90, container.dom.offsetWidth / container.dom.offsetHeight, 1, 10000 );
			camera.position.set( 0, 0, 200 );

			// control
			mousecontrol = new THREE.TrackballControls(camera,container.dom);
			mousecontrol.zoomSpeed = 1.5;
			mousecontrol.panSpeed = 0.8;
			mousecontrol.staticMoving = true;
			mousecontrol.dynamicDampingFactor = 0.3;

			// load resources
			// texture
			

			// material
			

			
				
			
			
			function animate() {
				
				sk.traverse(function (obj) {
					if(obj.name == 'unit')
						obj.rotation.y += 10/180/Math.PI;
				});
				
				mousecontrol.update();
				mousecontrol.handleResize();
				render(); 			
				requestAnimationFrame( animate );  
			}
			
			function render() {
				if (currentUnitMat.name == 'toon') {
					console.log('t')
					effect.render( scene, camera );
				} else {
					renderer.render( scene, camera );
				}
			}

			// ks
			var sidebar = new Sidebar(signals);
			document.body.appendChild(sidebar.dom);

			var topbar = new TopBar(signals);
			document.body.appendChild(topbar.dom);

			// var sculpture = new THREE.Group();
			// scene.add(sculpture);
			// sculpture.core = new Element();
			// sculpture.add(sculpture.core);
			// var ksString = []
			// var strings = 'incr_0,20,0 [ circle_20,70,z [ circle_3,0,y [ e ] ] ]';
			// //var strings = 'incr_0,20,0 [ heart_30,2 [ circle_3,0,y [ e ] ] ]';
			// sculpture.core = sculpture.core.fromString(strings);

			var sk = new Sculpture(axisLib['circle'],unitLib[unitList[0]],new Element('circle','3,0,y'),new Element('incr','0,20,0'));
			scene.add(sk);
			animate();

			// build sculpture
			// sculpture.core.find('e').add(currentUnit.clone());
			// sculpture.core.generate('3');
			//scene.add( sculpture );


			window.addEventListener( 'resize', onWindowResize, false );
			function onWindowResize() {

				camera.aspect = container.dom.offsetWidth/ container.dom.offsetHeight
				camera.updateProjectionMatrix();
								
				renderer.setSize( container.dom.offsetWidth, container.dom.offsetHeight);
				
				mousecontrol.handleResize();
				//render();

			}

		</script>
	</body>
</html>