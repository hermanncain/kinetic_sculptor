<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Kinetic Sculptor</title>
		<meta charset="utf-8">
		<script src="utils/d3.min.js"></script>
		<script src="utils/three.min.js"></script>
		<script src="utils/ui.js"></script>
		<script src="utils/TrackballControls.js"></script>
		<script src="StringCalc.js"></script>
		<script src="Toolbox.js"></script>
	</head>
	<body>
		<link href="css/main.css" rel="stylesheet" />
		<link id="theme" href="css/light.css" rel="stylesheet" />
		<script src="WordList.js"></script>
		<script src="generation.js"></script>
		<script src="Rule.js"></script>
		<script src="Element.js"></script>
		<script src="TreeOperation.js"></script>
		<script src="d3Tree.js"></script>
		<script>

			// number compare function
			var compare = function (x, y) {
				if (x < y) return -1;
				else if (x > y) return 1;
				else return 0;
			}

			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;

			var container = new UI.Panel();
			container.setId('viewport');
			document.body.appendChild( container.dom );

			var tool = new Toolbox();
			document.body.appendChild(tool.dom);

			var renderer = new THREE.WebGLRenderer( { antialias: true } );
			renderer.setClearColor( 0xFAFFFF );
			renderer.setPixelRatio( window.devicePixelRatio );
			renderer.setSize( container.dom.offsetWidth, container.dom.offsetHeight );
			container.dom.appendChild( renderer.domElement );

			var scene, camera;
			
			// scene
			scene = new THREE.Scene();
			scene.background = new THREE.Color(0xffffff);
			/*scene.background = new THREE.CubeTextureLoader()
				.setPath( 'bg/' )
				.load( [ 'px.png', 'nx.png', 'py.png', 'ny.png', 'pz.png', 'nz.png' ] );*/

			// main camera
			camera = new THREE.PerspectiveCamera( 90, container.dom.offsetWidth / container.dom.offsetHeight, 1, 10000 );
			camera.position.set( 0, 0, 200 );

			// lights
			var directionalLight = new THREE.DirectionalLight( 0xffffff,1);
			directionalLight.position.set( 1, 1, 1 );
			scene.add(directionalLight)
			scene.add( new THREE.AmbientLight(0x0));

			// control
			mousecontrol = new THREE.TrackballControls(camera,container.dom);
			mousecontrol.zoomSpeed = 1.5;
			mousecontrol.panSpeed = 0.8;
			mousecontrol.staticMoving = true;
			mousecontrol.dynamicDampingFactor = 0.3;
				
			window.addEventListener( 'resize', onWindowResize, false );
			
			function animate() {
				
				sculpture.traverse(function (obj) {
					if(obj.name == 'unit')
						obj.rotation.z += 10/180/Math.PI;
				});
				
				mousecontrol.update();
				mousecontrol.handleResize();
				render(); 			
				requestAnimationFrame( animate );  
			}
			
			function render() {

				renderer.render( scene, camera );
				
			}
			
			/*****************dynamic sculpture********************/
			
			// unit
			/*var map = new THREE.CubeTextureLoader()
					.setPath( 'bg/' )
					.load( [ 'px.png', 'nx.png', 'py.png', 'ny.png', 'pz.png', 'nz.png' ] );*/
			var material = new THREE.MeshStandardMaterial( { color: 0xfcfcfc,emissive:0x7d7d7d,meltaness:0.5/*a3adb6, envMap: map */} );
			var plate = new THREE.Mesh(new THREE.CylinderGeometry(5,5,1), material);
			plate.translateX(20);
			var bar = new THREE.Mesh(new THREE.CylinderGeometry(0.5,0.5,20), material);
			bar.rotateZ(Math.PI/2);
			bar.translateY(-10);
			var bear = new THREE.Mesh(new THREE.CylinderGeometry(1,1,2), material);
			bear.rotateX(Math.PI/2);
			var unit = new THREE.Group();
			unit.add(plate,bar,bear);
            unit.name = 'unit';
            
			// tree strings
			var ds = 'incs_0.7,0.7,0.7 [ linear_1,1,3,0,0,45 [ incr_y,16 [ circle_30,40 [ r_x,90 [ circle_3,10 [ e ] ] ] ] ] ]'
			var dna = 'incr_y,16 [ linear_1,20,1,0,12,0 [ r_x,90 [ circle_3,10 [ e ] ] ] ]'
			var dsp = 'octa_20,140 [ e ]'
            var dst = 'incr_0,8,0 [ circle_30,40 [ r_90,0,0 [ circle_3,10 [ e ] ] ] ]';
			var ds1 = 'circle_18,20,60 [ r_x,90 [ circle_4,90,-45 [ incs_0.9,1,0.9 [ circle_6,40 [ e ] ] ] ] ]';
			var ds2 = 'spiral_20,10,20,50,3 [ r_x,90 [ circle_4,20 [ e ] ] ]'
			var ds3 = 'incr_z,10 [ linear_1,1,40,0,0,3 [ e ] ]'

			// sculpture example
			var example = 'incr_0,8,0 [ circle_30,40 [ r_90,0,0 [ circle_3,0 [ e ] ] ] ]';
			var sculpture = new Element();
			sculpture = sculpture.fromString(example);
			sculpture.find('e').add(unit.clone());
			sculpture.generate('3');
			scene.add(sculpture);
			
			animate();
			
			var d3tree = new d3Tree(sculpture.toJSON());
			d3tree.draw();
			d3tree.relocateSvg( window.innerWidth-300,50 );
					
			function onWindowResize() {

				camera.aspect = container.dom.offsetWidth/ container.dom.offsetHeight
				camera.updateProjectionMatrix();
								
				renderer.setSize( container.dom.offsetWidth, container.dom.offsetHeight);
				d3tree.relocateSvg( window.innerWidth-300,50 );
				
				d3tree.resizeSvg( windowHalfX, windowHalfY );
				d3tree.resizeTree( windowHalfX, windowHalfY );
				
				mousecontrol.handleResize();
				render();

			}

		</script>
	</body>
</html>